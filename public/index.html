<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live‑Add UI Demo (state‑aware + isolated chat)</title>
<style>
/* ------------------------------------------------------------------ */
/* Layout – split screen                                            */
/* ------------------------------------------------------------------ */
body, html { margin:0; padding:0; height:100%; font-family:system-ui, sans-serif; }
#app { display:flex; height:100vh; overflow:hidden; }

/* Demo side – everything the AI can touch */
#demo-root { margin: 0; padding: 0; flex: 1; position: relative; background: #fff; overflow: hidden; }

/* Chat side – never touched by the AI */
#chat { width:320px; border-left:1px solid #ddd; display:flex; flex-direction:column; background:#fff; }
#messages { flex:1; overflow-y:auto; padding:0.5rem; }
.msg { margin:0.4rem 0; max-width:90%; }
.msg.user { text-align:right; }
.msg.ai   { text-align:left; }
.msg .bubble { display:inline-block; padding:0.5rem 0.8rem; border-radius:0.8rem; }
.msg.user .bubble { background:#007bff; color:#fff; }
.msg.ai .bubble   { background:#e5e5e5; color:#000; }
#inputForm { display:flex; border-top:1px solid #ddd; }
#input { flex:1; padding:0.6rem; border:none; outline:none; }
#sendBtn { padding:0.6rem 1rem; border:none; background:#007bff; color:#fff; cursor:pointer; }

/* ------------------------------------------------------------------ */
/* Placeholder for the AI‑generated CSS – we keep the element empty      */
/* ------------------------------------------------------------------ */
</style>

<!-- THE ONLY REQUIRED STYLE TAG THAT WILL BE POPULATED BY JS -->
<style id="demo-style"></style>
</head>
<body>

<div id="app">
  <!-- Demo area – everything the AI can modify -->
  <div id="demo-root"></div>

  <!-- Chat UI – never touched by the AI -->
  <div id="chat">
    <div id="messages"></div>
    <form id="inputForm">
      <input id="input" placeholder="Ask me to add / change something…" autocomplete="off" />
      <button id="sendBtn" type="submit">▶</button>
    </form>
  </div>
</div>

<script>
/* ============================================================= */
/* 1️⃣ GLOBAL STATE                                               */
/* ============================================================= */
let demoHTML = "";          // current HTML (inside #demo-root)
let demoCSS  = "";          // current CSS (scoped to #demo-root)
let demoJS   = "";          // current JavaScript (will run in iframe)
let userHistory = [];       // list of user prompts (sent to the model)

/* ============================================================= */
/* 2️⃣ Helper – add a chat bubble                                 */
/* ============================================================= */
function addBubble(text, from) {
  const container = document.createElement('div');
  container.className = `msg ${from}`;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = text;
  container.appendChild(bubble);
  document.getElementById('messages').appendChild(container);
  container.scrollIntoView({ behavior: 'smooth' });
}

/* ============================================================= */
/* 4️⃣ Build the demo iframe content (HTML + CSS + JS)            */
/* ============================================================= */
function buildIframeSrcDoc() {
  // The iframe will get a full HTML document.
  // We put the CSS inside a <style> tag (scoped automatically by our prefixing).
  // The JS is placed at the end of the body so it runs after the DOM is built.
  return `
<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8">
<title>Demo</title>
<style>
${scopeCSS(demoCSS)}
</style>
</head>
<body>
<div id="demo-root">${demoHTML}</div>
<scr` + `ipt>${demoJS}</scr` + `ipt></body></html>`.trim();
}

/* -------------------------------------------------------------- */
/* 5️⃣ Apply the AI reply (replace HTML, CSS, JS)                  */
/* -------------------------------------------------------------- */
function applyReply(reply) {
  const codeBlocks = [...reply.matchAll(/```(html|css|js|javascript)?\s*([\s\S]*?)```/gi)];
  if (codeBlocks.length === 0) return; // nothing to apply

  let newHTML = "";
  let newCSS  = "";
  let newJS   = "";
  let htmlChanged = false,
      cssChanged  = false,
      jsChanged   = false;

  for (const [, lang, code] of codeBlocks) {
    const normalized = (lang || "").trim().toLowerCase();
    if (normalized === "html") {
      newHTML += code + "\n";
      htmlChanged = true;
    } else if (normalized === "css") {
      newCSS += code + "\n";
      cssChanged = true;
    } else if (normalized === "js" || normalized === "javascript") {
      newJS += code + "\n";
      jsChanged = true;
    } else {
      // fallback guess
      if (code.includes("<") && code.includes(">")) {
        newHTML += code + "\n";
        htmlChanged = true;
      } else if (/function|document\.|window\./.test(code)) {
        newJS += code + "\n";
        jsChanged = true;
      } else {
        newCSS += code + "\n";
        cssChanged = true;
      }
    }
  }

  // ---- update the global buffers -------------------------------------------------
  if (htmlChanged) demoHTML = newHTML.trim();
  if (cssChanged)  demoCSS  = newCSS.trim();
  if (jsChanged)   demoJS   = newJS.trim();

  // ---- Re‑create the sandboxed iframe (this automatically picks up the new CSS) -
  const oldIframe = document.getElementById('demo-frame');
  if (oldIframe) oldIframe.remove();          // destroy previous execution context

  const iframe = document.createElement('iframe');
  iframe.id = 'demo-frame';
  iframe.style.width = '100%';
  iframe.style.height = '100%';
  iframe.style.border = 'none';
  // sandbox: allow scripts + same‑origin (needed for the CSSStyleSheet API if you use it)
  iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
  iframe.srcdoc = buildIframeSrcDoc();        // <-- builds a full HTML document that includes CSS
  document.getElementById('demo-root').appendChild(iframe);
}

/* -------------------------------------------------------------- */
/* 4️⃣ Build the demo iframe source (HTML + CSS + JS)              */
/* -------------------------------------------------------------- */
function buildIframeSrcDoc() {
  // The CSS is inserted exactly as we received it.
  // Because the whole page lives inside an iframe, we do NOT need to prefix selectors.
  // If you *do* want the model’s CSS to be scoped to #demo-root inside the iframe,
  // keep the `scopeCSS` call – it won’t hurt anything.
  return `
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Demo</title>
<style>
${demoCSS}
</style>
</head>
<body>
<div id="demo-root">
${demoHTML}
</div>
<scr` + `ipt>
${demoJS}
</scr` + `ipt>
</body>
</html>
`.trim();
}

/* ============================================================= */
/* 6️⃣ Main chat handler – sends prompt + current state + history*/
/* ============================================================= */
document.getElementById('inputForm').addEventListener('submit', async e => {
  e.preventDefault();
  const inputEl = document.getElementById('input');
  const prompt = inputEl.value.trim();
  if (!prompt) return;
  inputEl.value = "";

  // Show the user message
  addBubble(prompt, 'user');

  // Build payload for the backend
  const payload = {
    prompt,
    history: userHistory.slice(-10), // keep only last 10 prompts
    state: {
      html: demoHTML,
      css: demoCSS,
      js: demoJS
    }
  };

  // Add the new prompt to history (will be sent on the *next* request)
  userHistory.push(prompt);

  try {
    const resp = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await resp.json();
    const reply = data.reply ?? "⚠️ No reply";
    addBubble(reply, 'ai');
    applyReply(reply);
  } catch (err) {
    console.error(err);
    addBubble('❌ Request failed', 'ai');
  }
});
</script>
</body>
</html>
